<!DOCTYPE html>
<html>
  <head>
  	<title>2017 Arts in Schools Explorer</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
	   	integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   		crossorigin=""/>
   	<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
	   	integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   		crossorigin=""></script>
    <script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>

    <script type="text/javascript" src="colorbrewer.js"></script>
    <script type="text/javascript" src="leaflet.hexbin-layer.js"></script>

    <style type="text/css">
      	html, body { margin: 0; padding: 0; height: 100%; }
      	#schools { min-height: 95%; }
      	.hexagon { opacity: 0.7 }
    </style>
    <style>
	  	div.tooltip {
	  		position: absolute;
	  		text-align: center;
			width: auto;
	  		height: auto;
	  		padding: 5px 5px;
	  		font-size: 12px;
	  		font-family: Arial, Helvetica, sans-serif;
	  		color: black;
	  		border-radius: 5px;
	  		border-width: 1px;
	  		border-style: solid;
	  		border-color: #AAAAAA;
	  		background: #EEEEEE;
	  		pointer-events: none;
		}
</style>
</head>
<body>
	<select id="hexRadius" onchange="updateRadius()">
	  <option value="5">5
	  <option value="6">6
	  <option value="7">7
	  <option value="8">8
	  <option value="9">9
	  <option selected="selected" value="10">10
	  <option value="11">11
	  <option value="12">12
	  <option value="13">13
	  <option value="14">14
	  <option value="15">15
	  <option value="16">16
	  <option value="17">17
	  <option value="18">18
	  <option value="19">19
  	  <option value="20">20
	</select>

    <div id='schools' data-source="https://raw.githubusercontent.com/ilyakats/CUNY-DATA608/master/final/arts/schools.csv"></div>
    <script type="text/javascript">
		var grayscale = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
				subdomains: 'abcd'}),
			streets = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
				subdomains: 'abcd'});
		var baseMaps = {
				"Basic map": grayscale,
			    "Street names": streets
			};
		var max, scale, dataLayer,
			classes = 9,
            scheme = colorbrewer["Greens"][classes],
            container = L.DomUtil.get('schools');
		var map = L.map(container, {center: [40.732589, -73.983611], zoom: 11, layers : [grayscale]});

		L.control.layers(baseMaps).addTo(map);

        d3.csv(container.dataset.source).then(function(data) {
				function reformat (array) {
					var data = [];
					array.map(function (d){
						data.push({
							properties: {
							code: d.Code,
					        name: d.Name,
					        address: d.Address,
					        events: [+d.Q38_1, +d.Q38_2, +d.Q38_3, +d.Q38_4, +d.Q38_5, +d.Q38_6]
				      		},
							type: "Feature",
							geometry: {
								coordinates:[+d.LongitudeShifted, +d.LatitudeShifted],
								type:"Point"
							}
						});
					});
					return data;
				}
			geoData = { type: "FeatureCollection", features: reformat(data) };
			dataLayer = L.hexLayer(geoData,  { applyStyle: hex_style, radius: 10 });
			dataLayer.addTo(map);
		});

		function hex_style(hexagons) {
			// Maintain a density scale relative to initial zoom level.
			if (!(max && scale)) {
				max = d3.max(hexagons.data(), function (d) { return d3.sum(d, function(d) { return d[2].events.reduce(function(a, b) { return a+b; });}) });
				scale = d3.scaleQuantize()
						.domain([0, max])
						.range(d3.range(classes));
			}
			hexagons
				.attr("stroke", scheme[classes - 1])
				.attr("fill", function (d) { return scheme[scale(d3.sum(d, function(d) { return d[2].events.reduce(function(a, b) { return a+b; });}))]; });
		}

		function updateRadius() {
			var n = document.getElementById("hexRadius").value
			map.removeLayer(dataLayer);

    	    d3.csv(container.dataset.source).then(function(data) {
					function reformat (array) {
						var data = [];
						array.map(function (d){
							data.push({
								properties: {
								code: d.Code,
						        name: d.Name,
						        address: d.Address,
						        events: [+d.Q38_1, +d.Q38_2, +d.Q38_3, +d.Q38_4, +d.Q38_5, +d.Q38_6]
					      		},
								type: "Feature",
								geometry: {
									coordinates:[+d.LongitudeShifted, +d.LatitudeShifted],
									type:"Point"
								}
							});
						});
						return data;
					}
				geoData = { type: "FeatureCollection", features: reformat(data) };
				dataLayer = L.hexLayer(geoData,  { applyStyle: hex_style, radius: n });
				dataLayer.addTo(map);
			});
		};

    </script>
  </body>
</html>
